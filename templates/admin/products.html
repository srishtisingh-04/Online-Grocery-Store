{% extends "admin/base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Product Management</h2>
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#productModal" onclick="openProductModal()">
                Add New Product
            </button>
        </div>
    </div>
</div>

<div class="row mb-3">
    <div class="col-md-6">
        <div class="input-group">
            <input type="text" class="form-control" id="searchInput" placeholder="Search products...">
            <button class="btn btn-outline-secondary" type="button" id="searchBtn">Search</button>
        </div>
    </div>
    <div class="col-md-3">
        <select class="form-select" id="categoryFilter">
            <option value="">All Categories</option>
            <!-- Categories will be loaded dynamically -->
        </select>
    </div>
    <div class="col-md-3">
        <select class="form-select" id="statusFilter">
            <option value="">All Status</option>
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
        </select>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Category</th>
                        <th>Price</th>
                        <th>Stock</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="productsTable">
                    <!-- Products will be loaded dynamically -->
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        <nav aria-label="Products pagination">
            <ul class="pagination justify-content-center" id="pagination">
                <!-- Pagination will be loaded dynamically -->
            </ul>
        </nav>
    </div>
</div>

<!-- Product Modal -->
<div class="modal fade" id="productModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="productModalTitle">Add Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="productForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="productName" class="form-label">Product Name</label>
                                <input type="text" class="form-control" id="productName" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="productPrice" class="form-label">Price</label>
                                <input type="number" class="form-control" id="productPrice" step="0.01" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="productDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="productDescription" rows="3"></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="productCategory" class="form-label">Category</label>
                                <select class="form-select" id="productCategory" required>
                                    <!-- Categories will be loaded dynamically -->
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="productStock" class="form-label">Stock Quantity</label>
                                <input type="number" class="form-control" id="productStock" min="0" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="productImageUrl" class="form-label">Image URL</label>
                        <input type="url" class="form-control" id="productImageUrl">
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="productActive" checked>
                            <label class="form-check-label" for="productActive">
                                Active
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="saveProductBtn">Save Product</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentPage = 1;
let currentSearch = '';
let currentCategory = '';
let currentStatus = '';
let editingProductId = null;

// Load products
async function loadProducts() {
    try {
        const token = localStorage.getItem('token');
        let url = `/api/admin/products?page=${currentPage}`;
        
        if (currentSearch) url += `&search=${encodeURIComponent(currentSearch)}`;
        if (currentCategory) url += `&category_id=${currentCategory}`;
        
        const response = await fetch(url, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            displayProducts(data.products);
            displayPagination(data);
        } else {
            alert('Error loading products');
        }
    } catch (error) {
        console.error('Error loading products:', error);
        alert('Error loading products');
    }
}

// Display products
function displayProducts(products) {
    const productsTable = document.getElementById('productsTable');
    productsTable.innerHTML = '';
    
    products.forEach(product => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${product.id}</td>
            <td>${product.name}</td>
            <td>${product.category_name || 'N/A'}</td>
                        <td>â‚¹${product.price}</td>
            <td>${product.stock_quantity}</td>
            <td>
                <span class="badge bg-${product.is_active ? 'success' : 'danger'}">
                    ${product.is_active ? 'Active' : 'Inactive'}
                </span>
            </td>
            <td>
                <button class="btn btn-sm btn-primary" onclick="editProduct(${product.id})">Edit</button>
                <button class="btn btn-sm btn-danger" onclick="deleteProduct(${product.id})">Delete</button>
            </td>
        `;
        productsTable.appendChild(row);
    });
}

// Display pagination
function displayPagination(data) {
    const pagination = document.getElementById('pagination');
    pagination.innerHTML = '';
    
    for (let i = 1; i <= data.pages; i++) {
        const pageItem = document.createElement('li');
        pageItem.className = `page-item ${i === currentPage ? 'active' : ''}`;
        pageItem.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
        pagination.appendChild(pageItem);
    }
    
    // Add click listeners
    document.querySelectorAll('[data-page]').forEach(item => {
        item.addEventListener('click', (e) => {
            e.preventDefault();
            currentPage = parseInt(e.target.dataset.page);
            loadProducts();
        });
    });
}

// Load categories for dropdowns
async function loadCategories() {
    try {
        const token = localStorage.getItem('token');
        const response = await fetch('/api/admin/categories', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            const categoryFilter = document.getElementById('categoryFilter');
            const productCategory = document.getElementById('productCategory');
            
            data.categories.forEach(category => {
                const option1 = document.createElement('option');
                option1.value = category.id;
                option1.textContent = category.name;
                categoryFilter.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = category.id;
                option2.textContent = category.name;
                productCategory.appendChild(option2);
            });
        }
    } catch (error) {
        console.error('Error loading categories:', error);
    }
}

// Open product modal for adding
function openProductModal() {
    editingProductId = null;
    document.getElementById('productModalTitle').textContent = 'Add Product';
    document.getElementById('productForm').reset();
    document.getElementById('productActive').checked = true;
}

// Edit product
async function editProduct(productId) {
    try {
        const token = localStorage.getItem('token');
        const response = await fetch(`/api/admin/products/${productId}`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            const product = data.product;
            
            editingProductId = productId;
            document.getElementById('productModalTitle').textContent = 'Edit Product';
            document.getElementById('productName').value = product.name;
            document.getElementById('productDescription').value = product.description || '';
            document.getElementById('productPrice').value = product.price;
            document.getElementById('productCategory').value = product.category_id;
            document.getElementById('productStock').value = product.stock_quantity;
            document.getElementById('productImageUrl').value = product.image_url || '';
            document.getElementById('productActive').checked = product.is_active;
            
            new bootstrap.Modal(document.getElementById('productModal')).show();
        } else {
            alert('Error loading product');
        }
    } catch (error) {
        console.error('Error loading product:', error);
        alert('Error loading product');
    }
}

// Save product
document.getElementById('saveProductBtn').addEventListener('click', async () => {
    try {
        const token = localStorage.getItem('token');
        const formData = {
            name: document.getElementById('productName').value,
            description: document.getElementById('productDescription').value,
            price: parseFloat(document.getElementById('productPrice').value),
            category_id: parseInt(document.getElementById('productCategory').value),
            stock_quantity: parseInt(document.getElementById('productStock').value),
            image_url: document.getElementById('productImageUrl').value,
            is_active: document.getElementById('productActive').checked
        };
        
        const url = editingProductId ? `/api/admin/products/${editingProductId}` : '/api/admin/products';
        const method = editingProductId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(formData)
        });
        
        if (response.ok) {
            alert(editingProductId ? 'Product updated successfully!' : 'Product created successfully!');
            bootstrap.Modal.getInstance(document.getElementById('productModal')).hide();
            loadProducts();
        } else {
            const error = await response.json();
            alert(error.error || 'Error saving product');
        }
    } catch (error) {
        console.error('Error saving product:', error);
        alert('Error saving product');
    }
});

// Delete product
async function deleteProduct(productId) {
    if (!confirm('Are you sure you want to delete this product?')) {
        return;
    }
    
    try {
        const token = localStorage.getItem('token');
        const response = await fetch(`/api/admin/products/${productId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.ok) {
            alert('Product deleted successfully!');
            loadProducts();
        } else {
            alert('Error deleting product');
        }
    } catch (error) {
        console.error('Error deleting product:', error);
        alert('Error deleting product');
    }
}

// Search functionality
document.getElementById('searchBtn').addEventListener('click', () => {
    currentSearch = document.getElementById('searchInput').value;
    currentPage = 1;
    loadProducts();
});

document.getElementById('searchInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        currentSearch = e.target.value;
        currentPage = 1;
        loadProducts();
    }
});

// Filter functionality
document.getElementById('categoryFilter').addEventListener('change', (e) => {
    currentCategory = e.target.value;
    currentPage = 1;
    loadProducts();
});

document.getElementById('statusFilter').addEventListener('change', (e) => {
    currentStatus = e.target.value;
    currentPage = 1;
    loadProducts();
});

// Initialize page
document.addEventListener('DOMContentLoaded', () => {
    loadCategories();
    loadProducts();
});
</script>
{% endblock %}
