{% extends "admin/base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h2>Order Management</h2>
    </div>
</div>

<div class="row mb-3">
    <div class="col-md-6">
        <div class="input-group">
            <input type="text" class="form-control" id="searchInput" placeholder="Search orders...">
            <button class="btn btn-outline-secondary" type="button" id="searchBtn">Search</button>
        </div>
    </div>
    <div class="col-md-3">
        <select class="form-select" id="statusFilter">
            <option value="">All Status</option>
            <option value="pending">Pending</option>
            <option value="processing">Processing</option>
            <option value="shipped">Shipped</option>
            <option value="delivered">Delivered</option>
            <option value="cancelled">Cancelled</option>
        </select>
    </div>
    <div class="col-md-3">
        <input type="date" class="form-control" id="dateFilter" placeholder="Filter by date">
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Order ID</th>
                        <th>Customer</th>
                        <th>Total Amount</th>
                        <th>Status</th>
                        <th>Order Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="ordersTable">
                    <!-- Orders will be loaded dynamically -->
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        <nav aria-label="Orders pagination">
            <ul class="pagination justify-content-center" id="pagination">
                <!-- Pagination will be loaded dynamically -->
            </ul>
        </nav>
    </div>
</div>

<!-- Order Details Modal -->
<div class="modal fade" id="orderModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Order Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="orderDetails">
                    <!-- Order details will be loaded dynamically -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Status Update Modal -->
<div class="modal fade" id="statusModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Update Order Status</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="statusForm">
                    <div class="mb-3">
                        <label for="newStatus" class="form-label">New Status</label>
                        <select class="form-select" id="newStatus" required>
                            <option value="pending">Pending</option>
                            <option value="processing">Processing</option>
                            <option value="shipped">Shipped</option>
                            <option value="delivered">Delivered</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="updateStatusBtn">Update Status</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentPage = 1;
let currentSearch = '';
let currentStatus = '';
let currentDate = '';
let selectedOrderId = null;

// Load orders
async function loadOrders() {
    try {
        const token = localStorage.getItem('token');
        let url = `/api/admin/orders?page=${currentPage}`;
        
        if (currentSearch) url += `&search=${encodeURIComponent(currentSearch)}`;
        if (currentStatus) url += `&status=${currentStatus}`;
        
        const response = await fetch(url, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            displayOrders(data.orders);
            displayPagination(data);
        } else {
            alert('Error loading orders');
        }
    } catch (error) {
        console.error('Error loading orders:', error);
        alert('Error loading orders');
    }
}

// Display orders
function displayOrders(orders) {
    const ordersTable = document.getElementById('ordersTable');
    ordersTable.innerHTML = '';
    
    orders.forEach(order => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>#${order.id}</td>
            <td>${order.user.first_name} ${order.user.last_name}</td>
                <td>₹${order.total_amount.toFixed(2)}</td>
            <td>
                <span class="badge bg-${getStatusColor(order.status)}">${order.status.toUpperCase()}</span>
            </td>
            <td>${new Date(order.created_at).toLocaleDateString()}</td>
            <td>
                <button class="btn btn-sm btn-info" onclick="viewOrder(${order.id})">View</button>
                <button class="btn btn-sm btn-warning" onclick="updateOrderStatus(${order.id})">Update Status</button>
            </td>
        `;
        ordersTable.appendChild(row);
    });
}

// Display pagination
function displayPagination(data) {
    const pagination = document.getElementById('pagination');
    pagination.innerHTML = '';
    
    for (let i = 1; i <= data.pages; i++) {
        const pageItem = document.createElement('li');
        pageItem.className = `page-item ${i === currentPage ? 'active' : ''}`;
        pageItem.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
        pagination.appendChild(pageItem);
    }
    
    // Add click listeners
    document.querySelectorAll('[data-page]').forEach(item => {
        item.addEventListener('click', (e) => {
            e.preventDefault();
            currentPage = parseInt(e.target.dataset.page);
            loadOrders();
        });
    });
}

// View order details
async function viewOrder(orderId) {
    try {
        const token = localStorage.getItem('token');
        const response = await fetch(`/api/admin/orders/${orderId}`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            const order = data.order;
            
            const orderDetails = document.getElementById('orderDetails');
            orderDetails.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Order Information</h6>
                        <p><strong>Order ID:</strong> #${order.id}</p>
                        <p><strong>Status:</strong> <span class="badge bg-${getStatusColor(order.status)}">${order.status.toUpperCase()}</span></p>
                        <p><strong>Total Amount:</strong> ₹${order.total_amount.toFixed(2)}</p>
                        <p><strong>Order Date:</strong> ${new Date(order.created_at).toLocaleString()}</p>
                    </div>
                    <div class="col-md-6">
                        <h6>Customer Information</h6>
                        <p><strong>Name:</strong> ${order.user.first_name} ${order.user.last_name}</p>
                        <p><strong>Email:</strong> ${order.user.email}</p>
                        <p><strong>Phone:</strong> ${order.user.phone || 'N/A'}</p>
                    </div>
                </div>
                
                <div class="mt-4">
                    <h6>Shipping Address</h6>
                    <p class="text-muted">${order.shipping_address}</p>
                </div>
                
                <div class="mt-4">
                    <h6>Order Items</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Quantity</th>
                                    <th>Price</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${order.order_items.map(item => `
                                    <tr>
                                        <td>${item.product_name}</td>
                                        <td>${item.quantity}</td>
                                        <td>₹${item.price.toFixed(2)}</td>
                                        <td>₹${(item.price * item.quantity).toFixed(2)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            new bootstrap.Modal(document.getElementById('orderModal')).show();
        } else {
            alert('Error loading order details');
        }
    } catch (error) {
        console.error('Error loading order details:', error);
        alert('Error loading order details');
    }
}

// Update order status
function updateOrderStatus(orderId) {
    selectedOrderId = orderId;
    new bootstrap.Modal(document.getElementById('statusModal')).show();
}

// Handle status update
document.getElementById('updateStatusBtn').addEventListener('click', async () => {
    try {
        const token = localStorage.getItem('token');
        const newStatus = document.getElementById('newStatus').value;
        
        const response = await fetch(`/api/admin/orders/${selectedOrderId}/status`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
                status: newStatus
            })
        });
        
        if (response.ok) {
            alert('Order status updated successfully!');
            bootstrap.Modal.getInstance(document.getElementById('statusModal')).hide();
            loadOrders();
        } else {
            const error = await response.json();
            alert(error.error || 'Error updating order status');
        }
    } catch (error) {
        console.error('Error updating order status:', error);
        alert('Error updating order status');
    }
});

// Get status color for badge
function getStatusColor(status) {
    const colors = {
        'pending': 'warning',
        'processing': 'info',
        'shipped': 'primary',
        'delivered': 'success',
        'cancelled': 'danger'
    };
    return colors[status] || 'secondary';
}

// Search functionality
document.getElementById('searchBtn').addEventListener('click', () => {
    currentSearch = document.getElementById('searchInput').value;
    currentPage = 1;
    loadOrders();
});

document.getElementById('searchInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        currentSearch = e.target.value;
        currentPage = 1;
        loadOrders();
    }
});

// Filter functionality
document.getElementById('statusFilter').addEventListener('change', (e) => {
    currentStatus = e.target.value;
    currentPage = 1;
    loadOrders();
});

document.getElementById('dateFilter').addEventListener('change', (e) => {
    currentDate = e.target.value;
    currentPage = 1;
    loadOrders();
});

// Initialize page
document.addEventListener('DOMContentLoaded', () => {
    loadOrders();
});
</script>
{% endblock %}
